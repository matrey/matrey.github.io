{"hash":"8a9b5332798b62aafe71a8b49721e8933cc95a9f","data":{"tag":{"title":"china","belongsTo":{"edges":[{"node":{"title":"China Mirrors","path":"/articles/china-mirrors/","date":"27 August 2020","timeToRead":3,"description":"Here is how to increase the speed of Debian, Docker, Node, PHP, Python setups, by using mirrors hosted inside China.","content":"<p>Here is how to increase the speed of Debian, Docker, Node, PHP, Python setups, by using mirrors hosted inside China.</p>\n<p>Note that regardless of where you are on the planet, you should also consider caching. That will be the topic of an upcoming article.</p>\n<h2 id=\"debian\"><a href=\"#debian\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Debian</h2>\n<p>As of 2020-08-27, the <a href=\"https://www.debian.org/mirror/list-full#CN\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Debian mirror list</a> mentions the following \"Push-Primary\" instances:</p>\n<ul>\n<li>ftp2.cn.debian.org</li>\n<li>ftp.cn.debian.org</li>\n<li>mirrors.tuna.tsinghua.edu.cn <strong>&#x3C;&#x3C; my pick since March 2020</strong></li>\n<li>mirrors.ustc.edu.cn</li>\n</ul>\n<p>Rewrite your <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">sources.list</code> with:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">sed -i </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">s#http://deb.debian.org/debian#http://mirrors.tuna.tsinghua.edu.cn/debian#</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #D8DEE9FF\"> /etc/apt/sources.list</span>\n<span style=\"color: #D8DEE9FF\">sed -i </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">s#http://security.debian.org/debian-security#http://mirrors.tuna.tsinghua.edu.cn/debian-security#</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #D8DEE9FF\"> /etc/apt/sources.list</span></code></pre>\n<h2 id=\"docker\"><a href=\"#docker\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Docker</h2>\n<h3 id=\"docker-setup-on-debianubuntu\"><a href=\"#docker-setup-on-debianubuntu\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Docker setup on Debian/Ubuntu</h3>\n<p><a href=\"https://mirror.tuna.tsinghua.edu.cn/help/docker-ce/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Tuna</a> has a mirror of <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">docker-ce</code> for China</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">curl -fsSL https://download.docker.com/linux/ubuntu/gpg </span><span style=\"color: #81A1C1\">|</span><span style=\"color: #D8DEE9FF\"> apt-key add -</span>\n<span style=\"color: #D8DEE9FF\">add-apt-repository </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu </span><span style=\"color: #ECEFF4\">$(</span><span style=\"color: #A3BE8C\">lsb_release -cs</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #A3BE8C\"> stable</span><span style=\"color: #ECEFF4\">\"</span>\n<span style=\"color: #D8DEE9FF\">apt-get update -y</span>\n<span style=\"color: #D8DEE9FF\">apt-get install -y docker-ce docker-ce-cli containerd.io</span>\n<span style=\"color: #D8DEE9FF\">systemctl start docker</span>\n<span style=\"color: #D8DEE9FF\">systemctl </span><span style=\"color: #88C0D0\">enable</span><span style=\"color: #D8DEE9FF\"> docker</span></code></pre>\n<h3 id=\"docker-registry\"><a href=\"#docker-registry\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Docker registry</h3>\n<p>As of 2020, <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">registry.docker-cn.com</code> is dead, but Azure CN offers a reliable mirror (thanks <a href=\"https://xuxinkun.github.io/2019/06/11/cn-registry/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://xuxinkun.github.io/2019/06/11/cn-registry/</a>)</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #88C0D0\">echo</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">{\"registry-mirrors\": [\"https://dockerhub.azk8s.cn\"]}</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\"> /etc/docker/daemon.json</span>\n<span style=\"color: #D8DEE9FF\">systemctl restart docker</span></code></pre>\n<h2 id=\"node\"><a href=\"#node\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Node</h2>\n<h3 id=\"npm-registry\"><a href=\"#npm-registry\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>NPM registry</h3>\n<p>Taobao has a mirror of npm within China</p>\n<p>One shot:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">npm --registry https://registry.npm.taobao.org install express</span></code></pre>\n<p>To persist on user:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">npm config </span><span style=\"color: #88C0D0\">set</span><span style=\"color: #D8DEE9FF\"> registry https://registry.npm.taobao.org</span></code></pre>\n<p>Or by directly writing the configuration file at <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">~/.npmrc</code></p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #88C0D0\">echo</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">registry=https://registry.npm.taobao.org</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">~</span><span style=\"color: #D8DEE9FF\">/.npmrc</span></code></pre>\n<h2 id=\"php\"><a href=\"#php\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>PHP</h2>\n<h3 id=\"composer-setup\"><a href=\"#composer-setup\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Composer setup</h3>\n<p>Based on <a href=\"https://getcomposer.org/doc/faqs/how-to-install-composer-programmatically.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to install Composer programmatically</a> and <a href=\"https://pkg.phpcomposer.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://pkg.phpcomposer.com/</a>:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">php -r </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">copy('https://install.phpcomposer.com/installer', 'composer-setup.php');</span><span style=\"color: #ECEFF4\">\"</span>\n<span style=\"color: #D8DEE9FF\">php composer-setup.php --quiet</span>\n<span style=\"color: #D8DEE9FF\">php -r </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">unlink('composer-setup.php');</span><span style=\"color: #ECEFF4\">\"</span></code></pre>\n<p><em>Comparing <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">https://getcomposer.org/installer</code> with <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">https://install.phpcomposer.com/installer</code> out of curiosity:</em></p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">645c645</span>\n<span style=\"color: #81A1C1\">&lt;</span><span style=\"color: #D8DEE9FF\">         </span><span style=\"color: #81A1C1\">$</span><span style=\"color: #D8DEE9\">this</span><span style=\"color: #D8DEE9FF\">-</span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\">baseUrl = </span><span style=\"color: #81A1C1\">$</span><span style=\"color: #D8DEE9\">uriScheme</span><span style=\"color: #D8DEE9FF\">.</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">://getcomposer.org</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #D8DEE9FF\">---</span>\n<span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\">         </span><span style=\"color: #81A1C1\">$</span><span style=\"color: #D8DEE9\">this</span><span style=\"color: #D8DEE9FF\">-</span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\">baseUrl = </span><span style=\"color: #81A1C1\">$</span><span style=\"color: #D8DEE9\">uriScheme</span><span style=\"color: #D8DEE9FF\">.</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">://install.phpcomposer.com</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #D8DEE9FF\">827c827</span>\n<span style=\"color: #81A1C1\">&lt;</span><span style=\"color: #D8DEE9FF\">         </span><span style=\"color: #81A1C1\">$</span><span style=\"color: #D8DEE9\">url</span><span style=\"color: #D8DEE9FF\"> = </span><span style=\"color: #81A1C1\">$</span><span style=\"color: #D8DEE9\">this</span><span style=\"color: #D8DEE9FF\">-</span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\">baseUrl.</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">/versions</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #D8DEE9FF\">---</span>\n<span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\">         </span><span style=\"color: #81A1C1\">$</span><span style=\"color: #D8DEE9\">url</span><span style=\"color: #D8DEE9FF\"> = </span><span style=\"color: #81A1C1\">$</span><span style=\"color: #D8DEE9\">this</span><span style=\"color: #D8DEE9FF\">-</span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\">baseUrl.</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">/versions.json</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #81A1C1\">;</span></code></pre>\n<p>Make composer available to the local user with:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">mkdir -p </span><span style=\"color: #81A1C1\">~</span><span style=\"color: #D8DEE9FF\">/.local/bin/</span>\n<span style=\"color: #D8DEE9FF\">mv composer.phar </span><span style=\"color: #81A1C1\">~</span><span style=\"color: #D8DEE9FF\">/.local/bin/composer</span></code></pre>\n<h3 id=\"packagist-mirror\"><a href=\"#packagist-mirror\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Packagist mirror</h3>\n<p>As of 2020-08-27, the <a href=\"https://packagist.org/mirrors\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Packagist mirror page</a> lists:</p>\n<ul>\n<li>mirrors.huaweicloud.com/repository/php</li>\n<li>developer.aliyun.com/composer <strong>&#x3C;&#x3C; works OK</strong></li>\n<li>php.cnpkg.org</li>\n<li>packagist.phpcomposer.com</li>\n<li>packagist.mirrors.sjtug.sjtu.edu.cn</li>\n<li>mirrors.cloud.tencent.com/help/composer.html <strong>&#x3C;&#x3C; works OK</strong></li>\n</ul>\n<p>Apply with the <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">composer config</code> command:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</span></code></pre>\n<p>Or you can directly write into <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">~/.config/composer/config.json</code>:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">mkdir -p </span><span style=\"color: #81A1C1\">~</span><span style=\"color: #D8DEE9FF\">/.config/composer/</span>\n<span style=\"color: #88C0D0\">echo</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">{\"repositories\":{\"packagist\":{\"type\":\"composer\",\"url\":\"https://mirrors.aliyun.com/composer/\"}}}</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">~</span><span style=\"color: #D8DEE9FF\">/.config/composer/config.json</span></code></pre>\n<h2 id=\"python\"><a href=\"#python\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Python</h2>\n<h3 id=\"pip--pypi\"><a href=\"#pip--pypi\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>pip / PyPI</h3>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">pip config </span><span style=\"color: #88C0D0\">set</span><span style=\"color: #D8DEE9FF\"> global.index-url </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">https://pypi.tuna.tsinghua.edu.cn/simple</span><span style=\"color: #ECEFF4\">\"</span></code></pre>\n<p>Or to avoid running pip (for instance in a Dockerfile, as it would pollute the image), write directly to <code class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\">~/.config/pip/pip.conf</code></p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #D8DEE9FF\">mkdir -p /root/.config/pip/</span>\n<span style=\"color: #88C0D0\">echo</span><span style=\"color: #D8DEE9FF\"> -e </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">[global]\\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple\\n</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">~</span><span style=\"color: #D8DEE9FF\">/.config/pip/pip.conf</span></code></pre>\n<hr>\n<p><em>Cover image adapted from <a href=\"https://xkcd.com/303/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://xkcd.com/303/</a> ; Creative Commons Attribution-NonCommercial 2.5 License</em></p>\n"}}]}}},"context":{}}